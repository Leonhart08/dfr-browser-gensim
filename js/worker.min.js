"use strict";importScripts("utils.min.js");var my={conditional:{},conditional_total:{},doc_categories:{}},doc_topics_matrix,total_tokens,topic_docs,doc_topics,topic_conditional,conditional_total,topic_docs_conditional;doc_topics_matrix=function(t){var o={},i=t;if(i.p&&i.p.length){i.n=i.p.length-1}i.get=function(t,o){var i,a,n,e;if(!this.x){return undefined}if(t===undefined){return this}if(o===undefined){e=[];for(n=0;n<this.n;n+=1){e.push(this.get(t,n))}return e}i=this.p[o];a=utils.bisect_left(this.i.slice(i,this.p[o+1]),t);e=this.i[a+i]===t?this.x[a+i]:0;return e};i.row_sum=function(t){var i,a,n;if(!this.x){return undefined}if(!o.row_sum){o.row_sum=[]}if(t===undefined){for(a=0;a<this.n;a+=1){for(n=this.p[a];n<this.p[a+1];n+=1){if(o.row_sum[this.i[n]]===undefined){o.row_sum[this.i[n]]=0}o.row_sum[this.i[n]]+=this.x[n]}}return o.row_sum}if(!o.row_sum[t]){i=0;for(a=0;a<this.n;a+=1){i+=this.get(t,a)}o.row_sum[t]=i}return o.row_sum[t]};i.col_sum=function(t){var i;if(!o.col_sum){o.col_sum=[]}if(t===undefined){for(i=0;i<this.n;i+=1){this.col_sum(i)}return o.col_sum}if(!o.col_sum[t]){o.col_sum[t]=0;for(i=this.p[t];i<this.p[t+1];i+=1){o.col_sum[t]+=this.x[i]}}return o.col_sum[t]};return i};total_tokens=function(){var t,o=0;for(t=0;t<my.dt.x.length;t+=1){o+=my.dt.x[t]}return o};topic_docs=function(t,o){return topic_docs_conditional(t,undefined,undefined,o)};doc_topics=function(t,o){var i=[],a,n;for(a=0;a<my.dt.n;a+=1){n=my.dt.get(t,a);if(n>0){i.push({topic:a,weight:n})}}i.sort(function(t,o){return utils.desc(t.weight,o.weight)||utils.desc(t.t,o.t)});return utils.shorten(i,o,function(t,o){return t[o].weight})};topic_conditional=function(t,o){var i,a,n;if(!my.conditional[t]){my.conditional[t]={}}if(o===undefined){i=[];for(a=0;a<my.dt.n;a+=1){i.push(topic_conditional(t,a))}return i}if(my.conditional[t][o]){return my.conditional[t][o]}i={};for(a=my.dt.p[o];a<my.dt.p[o+1];a+=1){n=my.doc_categories[t][my.dt.i[a]];if(n==undefined){}if(i[n]){i[n]+=my.dt.x[a]}else{i[n]=my.dt.x[a]}}console.log("RESULT");console.log(i);for(n in i){if(i.hasOwnProperty(n)){i[n]/=conditional_total(t,n)}}my.conditional[t][o]=i;return i};conditional_total=function(t,o){var i,a,n;if(!my.conditional_total[t]){i={};for(n=0;n<my.dt.i.length;n+=1){a=my.doc_categories[t][my.dt.i[n]];if(i[a]){i[a]+=my.dt.x[n]}else{i[a]=my.dt.x[n]}}my.conditional_total[t]=i}return o!==undefined?my.conditional_total[t][o]:my.conditional_total[t]};topic_docs_conditional=function(t,o,i,a){var n=my.dt.p[t],e=my.dt.p[t+1],s,d=[],c,r,l,u=[];for(s=n;s<e;s+=1){if(o===undefined||my.doc_categories[o][my.dt.i[s]]===i){d.push({doc:my.dt.i[s],frac:my.dt.x[s]/my.dt.row_sum(my.dt.i[s]),weight:my.dt.x[s]})}}if(a>=d.length){d.sort(function(t,o){return utils.desc(t.frac,o.frac)||utils.desc(t.doc,o.doc)});return d}u=d.slice(0,a).sort(function(t,o){return utils.asc(t.frac,o.frac)||utils.asc(t.doc,o.doc)});c=utils.bisector_left(function(t){return t.frac});for(l=a;l<d.length;l+=1){r=c(u,d[l].frac);if(r>0){u.splice(r,0,d[l]);u.shift()}else if(u[0].frac===d[l].frac){u.unshift(d[l])}}return utils.shorten(u.reverse(),a,function(t,o){return t[o].frac})};onmessage=function(t){if(t.data.what==="set_dt"){my.dt=doc_topics_matrix(t.data.dt);if(my.dt){my.dt.row_sum()}postMessage({what:"set_dt",result:my.dt!==undefined})}else if(t.data.what==="set_doc_categories"){my.doc_categories[t.data.v]=t.data.keys;postMessage({what:"set_doc_categories",result:my.doc_categories[t.data.v]!==undefined})}else if(t.data.what==="total_tokens"){postMessage({what:"total_tokens",result:total_tokens()})}else if(t.data.what==="topic_docs"){postMessage({what:"topic_docs/"+t.data.t+"/"+t.data.n,result:topic_docs(t.data.t,t.data.n)})}else if(t.data.what==="doc_topics"){postMessage({what:"doc_topics/"+t.data.d+"/"+t.data.n,result:doc_topics(t.data.d,t.data.n)})}else if(t.data.what==="topic_total"){postMessage({what:"topic_total/"+t.data.t,result:my.dt.col_sum(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="topic_conditional"){console.log("WORKER");console.log(t.data.t);postMessage({what:"topic_conditional/"+t.data.v+"/"+t.data.t,result:topic_conditional(t.data.v,t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="conditional_total"){postMessage({what:"conditional_total/"+t.data.v+"/"+t.data.key,result:conditional_total(t.data.v,t.data.key==="all"?undefined:t.data.key)})}else if(t.data.what==="topic_docs_conditional"){postMessage({what:"topic_docs_conditional/"+t.data.t+"/"+t.data.v+"/"+t.data.key+"/"+t.data.n,result:topic_docs_conditional(t.data.t,t.data.v,t.data.key,t.data.n)})}else{postMessage({what:"error"})}};